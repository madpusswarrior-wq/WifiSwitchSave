name: Build SwitchSync (.nro)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container: devkitpro/devkita64:latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check toolchain (offline)
        shell: bash
        run: |
          set -e
          . /etc/profile.d/devkit-env.sh
          echo "DEVKITPRO=$DEVKITPRO"
          ls -l "$DEVKITPRO/libnx/lib/libnx.a"
          aarch64-none-elf-gcc --version

      - name: Ensure Makefile (no overwrite)
        shell: bash
        run: |
          set -e
          if [ ! -f Makefile ]; then
            printf '%s\n' \
'# Auto-generated minimal libnx Makefile' \
'TARGET      := SwitchSync' \
'BUILD       := build' \
'SOURCES     := source' \
'INCLUDES    :=' \
'' \
'APP_TITLE   := SwitchSync' \
'APP_AUTHOR  := You' \
'APP_VERSION := 0.1.0' \
'' \
'CFLAGS      := -O2 -ffunction-sections -fdata-sections -Wall -Wextra -Wno-unused-parameter -Wno-unused-variable' \
'CXXFLAGS    := $(CFLAGS) -fno-rtti -fno-exceptions' \
'CPPFLAGS    := -I$(DE
